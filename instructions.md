#**Инструкция по настройке роутера и установке софта.**

##***Введение***

В наличии имеется роутер gl-net-6416A (далее по тексту роутер или маленький роутер)

Описание роутера https://wiki.openwrt.org/toh/gl-inet/gl-inet_64xx
Прошивку OpenWRT в варианте GL-инет можно взять с ресурса http://www.gl-inet.com/downloads/
Обзор возможностей роутера с фото http://mysku.ru/blog/china-stores/26421.html
Видео с настройкой роутера https://www.youtube.com/watch?v=65ucyKd1DF8

В нашем экземпляре роутера GPIO выведены цветными проводами::
```
    GND  RX TX
      *  *  *
    |----------|
    |          |
    |          |
    |          |
    |          |
    |          |
    |          |
    |          |
    |----------|
  *  *  *  *  *  *
GND 20 19 18 22 21 (GPIO)

GND (ниж) - синий
GPIO :
20 -зеленый
19 - желтый
18 - оранжевый
22 - красный
21 - коричныевый
```
GPIO подтянуты к источнику +3,3В через резисторы 10 кОм

##***Установка и настройка прошивки OpenWRT***

Из Китая роутер приходит с вариантом прошивки от производителя - одна из старых сборок OpenWRT + некоторые специфические пакеты. Предположительно более правильным вариантом является установка на роутер официальной версии прошивки OpenWRT.
Для этого заходим по ссылке 
https://wiki.openwrt.org/toh/gl-inet/gl-inet_64xx скачиваем на ноут прошивку в варианте https://downloads.openwrt.org/chaos_calmer/15.05.1/ar71xx/generic/openwrt-15.05.1-ar71xx-generic-gl-inet-6416A-v1-squashfs-factory.bin
оставляем открытой страницу с инструкцией.
Проверяем, что на ноуте установлено автоматическое получение IP адреса и других сетевых параметров от роутера (DHCP)
Далее соединяем Ethernet порт ноута и LAN порт роутера патч-кордом, и действуем по инструкции.
Только учитывайте, что между п.6 и 7 инструкции сменится сеть, которую раздает роутер (на прошивке GL-inet сеть 192.168.8.0/24, а на родной OpenWRT - 192.168.1.0/24) Поэтому после окончания прошивки и до Do a happy dance нужно в роутере поменять адрес, по которому обращаться на роутер с 192.168.8.1 на 192.168.1.1
В результате  получим установленную прошивку "каноническая OpenWRT".

Теперь необходимо выполнить следующие настройки через вебморду, в начале процесса доступную в браузере по адресу 192.168.1.1 (если что-то идет не так, очистите в браузере куки и прочую историю):

Network > Interfaces,  LAN Edit: 
Меняем IPv4 address на 192.168.8.1 -  это позволит не путать адреса, раздаваемые этим роутером и основным роутером.
После этого, естественно, нужно перезайти браузером на интерфейс 192.168.8.1

Network > WiFi > Scan:
Присоединяетесь к wifi сети основного роутера (192.168.1.0/24) в качестве клиента

Network > Firewall:
для зоны firewall WAN в столбце input устанавливаете accept 

В результате этих манипуляций получаете роутер, который присоединяется к основному по wifi, получает адрес по DHCP из сети 192.168.1.0/24 (для него это адрес WAN), и делает у себя на LAN порту собственную сеть 192.168.8.0/24 раздавая адреса в ней по DHCP.
При этом WAN ethernet интерфейс остается незадействованным. Firewall фактически отключен. Сделано это для того, чтобы иметь возможность доступа к маленькому роутеру из сети основного роутера, не заморачиваясь созданием для этого отдельных правил.

На основном роутере квартиры тоже нужно проделать некоторые манипуляции:
1. В списке wifi клиентов найти маленький роутер, точнее его MAC адрес и в настройках DHCP указать в явном виде какой IP адрес присваивать ему, чтобы он каждый раз получал один и тот же IP.
2. Пробросить выбранный для удаленного доступа через WEB интерфейс порт (например 8888) на порт 80 IP адреса маленького роутера
3. Пробросить выбранный для удаленного доступа по SSH порт (например 9999) на порт, заданный в настройках маленького роутера для доступа по SSH 
4. В настройках маршрутов прописать статический маршрут к сети 192.168.8.0/24, указав что она доступна через IP адрес, который маленький роутер получает от основного (в нашем случае это 192.168.1.25). Это опционально, так как конфигурировать маленький роутер можно и из сети основного роутера по адресу 192.168.1.25. Однако приятно, что можно пинговать любой узел из обоих сетей.

После того как необходимость удаленного доступа из внешней сети к маленькому роутеру закончится, нужно убрать проброс портов на его WEB и SSH интерфейсы, чтобы изолировать его от интернета в целях безопасности.

После проделанных манипуляций маленький роутер подключен к основному роутеру квартиры в качестве клиента, и можно получить доступ к его веб-морде из основной сети по адресу, который ему присвоен. 

Кроме того, можно получить доступ через терминал по SSH:

```
ssh root@192.168.x.x -p ssh_port
```

Нажимаем yes и вводим пароль от учетной записи root.
Можно алогиниться неограниченное кол-во раз, чтобы выполнять разные задачи одновременно.

пример отправки файла с ноута на роутер через scp (выполняется из директории с файлом):

```
scp -P 2222 filename root@192.168.x.x:/remote_directory
```

Вводим пароль и файлы пересылаются.

Для обратной отправки необходимо разрешить доступ по SSH на MAC OS. Это можно сделать в настройках Sharing, "Enable remote login"

##***Настройка софта***

Как и во всех линуксах на OpenWRT есть менеджер установки пакетов. Его можно вызвать командой opkg.
Нам необходимо установить 3 пакета: 
python-light - облегченный язык программирования для разработки софта
ntpd - пакет для синронизации времени с удаленным сервером
mailsend - пакет для отправки писем из оболочки inux

Установка производится командами (перед каждой командой лучше прогнать opkg update):
```
opkg update
opkg install python-light
opkg install ntpd
opkg install mailsend

```
Теперь необходимо перейти в директорию /etc/config/ и до полнить файл system до следующего:
```
config system
        option hostname 'OpenWrt'
        option zonename 'Europe/Moscow'
        option timezone 'MSK-3'
        option conloglevel '7'
        option cronloglevel '5'

config timeserver 'ntp'
        list server '0.openwrt.pool.ntp.org'
        list server '1.openwrt.pool.ntp.org'
        list server '2.openwrt.pool.ntp.org'
        list server '3.openwrt.pool.ntp.org'
        option enabled '1'
        option enable_server '0'

config led 'led_lan'
        option name 'LAN'
        option sysfs 'gl-connect:green:lan'
        option trigger 'netdev'
        option dev 'eth1'
        option mode 'link tx rx'

config led 'led_wlan'
        option name 'WLAN'
        option sysfs 'gl-connect:red:wlan'
        option trigger 'phy0tpt'
```
Выполняем следующие команды для настройки ntpd (можно подробно почитать здесь https://wiki.openwrt.org/doc/howto/ntp.client):
```
/etc/init.d/sysntpd disable
/etc/init.d/ntpd enable
/etc/init.d/ntpd start
netstat -l | grep ntp
```
Мы отключили системное время и подключили установленный пакет для синхронизации. 
Теперь необходимо перезагрузить роутер.
```
reboot
```

**Краткая справка по полезным командам linux:**
```
mkdir din_name - создать папку din_name
ls - просмотреть все папки в текущей директории
ls -al - тоже самое, в виде списка
cd dir_name - переход в папку dir_name, (если ее видно в текущей директории)
если нет, то всегда можно перейти используя абсолютные пути cd /root/../dir_name 
(переход в кореневую директорию cd /)
cd .. переход на один шаг вверх
cd - переход в предыдущую директорию
pwd - посмотреть полный путь до текущей директории
mv file_name dir_name перемещение файла file_name в директорию dir_name
cp file_name dir_name копирование файла file_name в директорию dir_name
chmod +x filename - сделать файл filename исполняемым
rm filename - удалить файл filename
rm -r dir_name - удалить директорию dir_name
date - текущее дата и время
uname -a - спрака о версии ОС
```

Команда по отправке письма с роутера:

```
mailsend -to alexlember@gmail.com -from novokosino.home@gmail.com -starttls -port 587 -auth -smtp smtp.gmail.com -sub 'test' +cc +bc -v -user novokosino.home@gmail.com -pass 'pass' -mime-type 'text/html' -msg-body /root/test/test.html

```


Ввод данных

```
 echo "XX" > /sys/class/gpio/export
 echo "out" > /sys/class/gpio/gpioXX/direction
 echo "0" > /sys/class/gpio/gpioXX/value
```

Чтение данных

```
 echo YY > /sys/class/gpio/export
 echo in > /sys/class/gpio/gpioYY/direction
 cat /sys/class/gpio/gpioYY/value
```

Описание того, как заставить программу запускаться при старте https://wiki.openwrt.org/doc/techref/initscripts
https://forum.openwrt.org/viewtopic.php?id=25304
which python

Пока сделана быстрая реализация на коленке по статье http://askubuntu.com/questions/228304/how-do-i-run-a-script-at-start-up
По пути /etc/rc.local в файл добавлена строка:
/usr/bin/python /root/signalization_project/signalization.py

Кроме того, все пути в файле signalization.py объявлены как абсолютные. Конечно, их необходимо вынести в конфиги, но потом.
При загрузке программа крутится как демон на background, для просмотра событий можно заглянуть в логи:

```
cat /root/signalization_project_log
```

Все файлы из этого репозитория кроме данного instructions.md и readme.md должны лежать на роутере в одной папке 
(Например: /root/signalization_project)
